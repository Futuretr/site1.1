{% extends "base.html" %}

{% block content %}
<!-- Premium Kontrol -->
{% if not current_user.is_authenticated %}
    <!-- Hero Section -->
    <div class="hero-section position-relative overflow-hidden" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 80vh;">
        <div class="container py-5">
            <div class="row align-items-center min-vh-75">
                <div class="col-lg-6">
                    <div class="hero-content text-white">
                        <h1 class="display-4 fw-bold mb-4 animate-fade-in">
                            🏆 Türkiye'nin En Gelişmiş<br>
                            <span class="text-warning">At Yarışı Analiz Sistemi</span>
                        </h1>
                        <p class="lead mb-4 animate-fade-in-delay">
                            Yapay zeka destekli algoritmalarımızla 9 farklı şehirden canlı veri çekerek 
                            <strong class="text-warning">profesyonel</strong> at yarışı analizleri yapın!
                        </p>
                        <div class="hero-stats row mb-4 g-3">
                            <div class="col-md-4 col-12 text-center stat-item" data-tooltip="Son 6 ayda analiz edilen toplam koşu sayısı">
                                <h3 class="text-warning fw-bold counter mb-1" data-target="1500">0+</h3>
                                <small class="d-block text-white-50">Analiz Edilen Koşu</small>
                            </div>
                            <div class="col-md-4 col-12 text-center stat-item" data-tooltip="Sistem başarı oranımız">
                                <h3 class="text-warning fw-bold counter mb-1" data-target="77">0%</h3>
                                <small class="d-block text-white-50">Başarı Oranı</small>
                            </div>
                            <div class="col-md-4 col-12 text-center stat-item" data-tooltip="Aktif kullanıcı sayısı">
                                <h3 class="text-warning fw-bold counter mb-1" data-target="2800">0+</h3>
                                <small class="d-block text-white-50">Aktif Kullanıcı</small>
                            </div>
                        </div>
                        <div class="hero-buttons mb-4">
                            <a href="{{ url_for('auth.register') }}" class="btn btn-warning btn-lg me-3 animate-button">
                                <i class="fas fa-rocket"></i> Ücretsiz Başlayın
                            </a>
                            <a href="#ozellikler" class="btn btn-outline-light btn-lg animate-button">
                                <i class="fas fa-info-circle"></i> Özellikleri Görün
                            </a>
                        </div>
                        <div class="hero-badges">
                            <span class="badge bg-success me-2"><i class="fas fa-check"></i> 100% Ücretsiz Deneme</span>
                            <span class="badge bg-info me-2"><i class="fas fa-shield-alt"></i> Güvenli Platform</span>
                            <span class="badge bg-warning text-dark"><i class="fas fa-trophy"></i> #1 Analiz Sistemi</span>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="text-center">
                        <img src="https://images.unsplash.com/photo-1553284965-83fd3e82fa5a?ixlib=rb-4.0.3&w=600&h=400&fit=crop" 
                             alt="At Yarışı - Grup Koşu" class="img-fluid rounded shadow-lg mb-4" style="max-height: 300px; object-fit: cover;">
                        <div class="mt-3">
                            <h4 class="text-white mb-3">📊 Profesyonel Analiz Sistemi</h4>
                            <p class="text-white-50">Gelişmiş algoritmalarımızla at yarışı verilerini analiz edin ve başarılı tahminler yapın!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Özellikler Section -->
    <section id="ozellikler" class="py-5 bg-light">
        <div class="container">
            <div class="row mb-5">
                <div class="col-12 text-center">
                    <h2 class="display-5 fw-bold mb-3">🚀 Neden Bu Kadar Popüler?</h2>
                    <p class="lead text-muted">Türkiye'nin en kapsamlı at yarışı analiz sistemi</p>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="feature-card card h-100 border-0 shadow-sm">
                        <div class="card-body text-center p-4">
                            <div class="feature-icon mb-3">
                                <i class="fas fa-brain fa-3x text-primary"></i>
                            </div>
                            <h5 class="fw-bold">Yapay Zeka Algoritması</h5>
                            <p class="text-muted">Gelişmiş makine öğrenmesi ile %77.3 başarı oranına ulaştık.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="feature-card card h-100 border-0 shadow-sm">
                        <div class="card-body text-center p-4">
                            <div class="feature-icon mb-3">
                                <i class="fas fa-map-marked-alt fa-3x text-success"></i>
                            </div>
                            <h5 class="fw-bold">9 Şehir Kapsamı</h5>
                            <p class="text-muted">İstanbul, Ankara, İzmir ve 6 şehir daha! Türkiye'nin en kapsamlı ağı.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="feature-card card h-100 border-0 shadow-sm">
                        <div class="card-body text-center p-4">
                            <div class="feature-icon mb-3">
                                <i class="fas fa-clock fa-3x text-warning"></i>
                            </div>
                            <h5 class="fw-bold">Gerçek Zamanlı</h5>
                            <p class="text-muted">Canlı veri akışı ile anlık güncellemeler ve hızlı analizler.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Başarı İstatistikleri -->
    <section class="py-5 bg-primary text-white">
        <div class="container">
            <div class="row text-center">
                <div class="col-md-3 mb-4">
                    <h3 class="display-4 fw-bold counter" data-target="9">0</h3>
                    <p class="lead">Şehir Kapsamı</p>
                </div>
                <div class="col-md-3 mb-4">
                    <h3 class="display-4 fw-bold">%77.3</h3>
                    <p class="lead">Başarı Oranı</p>
                </div>
                <div class="col-md-3 mb-4">
                    <h3 class="display-4 fw-bold counter" data-target="1500">0+</h3>
                    <p class="lead">Analiz Edilen Koşu</p>
                </div>
                <div class="col-md-3 mb-4">
                    <h3 class="display-4 fw-bold counter" data-target="2800">0+</h3>
                    <p class="lead">Mutlu Kullanıcı</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Kullanıcı Yorumları -->
    <section class="py-5">
        <div class="container">
            <div class="row mb-5">
                <div class="col-12 text-center">
                    <h2 class="display-5 fw-bold mb-3">💬 Kullanıcılarımız Ne Diyor?</h2>
                    <p class="lead text-muted">Binlerce kullanıcıdan gelen gerçek yorumlar</p>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="testimonial-card card border-0 shadow-sm h-100">
                        <div class="card-body p-4">
                            <div class="stars mb-3 text-warning">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                            </div>
                            <p class="mb-3">"Profesyonel analiz sistemi! 9 şehirden veri çekebilmesi harika. Gerçekten kapsamlı bir platform."</p>
                            <div class="d-flex align-items-center">
                                <div>
                                    <h6 class="mb-0">Mehmet K.</h6>
                                    <small class="text-muted">Premium Üye - İstanbul</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="testimonial-card card border-0 shadow-sm h-100">
                        <div class="card-body p-4">
                            <div class="stars mb-3 text-warning">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                            </div>
                            <p class="mb-3">"Profesyonel analiz sistemi! Excel çıktıları sayesinde kendi stratejilerimi de geliştirebiliyorum. Harika bir platform."</p>
                            <div class="d-flex align-items-center">
                                <div>
                                    <h6 class="mb-0">Mustafa Ö.</h6>
                                    <small class="text-muted">Premium Üye - Ankara</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="testimonial-card card border-0 shadow-sm h-100">
                        <div class="card-body p-4">
                            <div class="stars mb-3 text-warning">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                            </div>
                            <p class="mb-3">"AI destekli analizler gerçekten işe yaríyor! %80'e yakın başarı oranım var artık."</p>
                            <div class="d-flex align-items-center">
                                <div>
                                    <h6 class="mb-0">Can Y.</h6>
                                    <small class="text-muted">Premium Üye - İzmir</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- CTA Section -->
    <section class="py-5 text-white" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <div class="container text-center">
            <h2 class="display-5 fw-bold mb-3">🎯 Hemen Başlayın!</h2>
            <p class="lead mb-4">Profesyonel analizlerle kazançlarınızı artırın</p>
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="d-grid gap-3 d-md-flex justify-content-md-center">
                        <a href="{{ url_for('auth.register') }}" class="btn btn-warning btn-lg px-5">
                            <i class="fas fa-rocket"></i> Ücretsiz Kayıt Ol
                        </a>
                        <a href="{{ url_for('auth.login') }}" class="btn btn-outline-light btn-lg px-5">
                            <i class="fas fa-sign-in-alt"></i> Giriş Yap
                        </a>
                    </div>
                    <div class="mt-3">
                        <small class="opacity-75">
                            <i class="fas fa-check"></i> Kredi kartı gerekmez 
                            <i class="fas fa-check ms-3"></i> Anında erişim
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </section>

{% else %}
    <!-- Authenticated User Dashboard -->
    <div class="container-fluid py-4">
        <!-- Kullanıcı Karşılama -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="card-body text-white">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h2 class="mb-1">Hoş geldiniz, {{ current_user.first_name }}!</h2>
                                <p class="mb-0 lead">At yarışı analiz sisteminize hoş geldiniz.</p>
                            </div>
                            <div class="col-md-4 text-end">
                                {% if current_user.is_premium %}
                                    <span class="badge bg-warning text-dark fs-6 p-2">
                                        <i class="fas fa-crown"></i> Premium Üye
                                    </span>
                                {% else %}
                                    <a href="{{ url_for('auth.premium') }}" class="btn btn-warning btn-lg">
                                        <i class="fas fa-crown"></i> Premium Ol
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ana İçerik -->
        <div class="row">
            <div class="col-lg-8">
                <!-- Analiz Paneli -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> At Yarışı Analiz Sistemi</h5>
                    </div>
                    <div class="card-body">
                        <!-- Şehir Seçimi -->
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="citySelect" class="form-label fw-bold">Şehir Seçin:</label>
                                <select class="form-select" id="citySelect" onchange="updateAnalysisInfo()">
                                    <option value="">Şehir seçiniz...</option>
                                    <option value="istanbul">İstanbul</option>
                                    <option value="ankara">Ankara</option>
                                    <option value="izmir">İzmir</option>
                                    <option value="bursa">Bursa</option>
                                    <option value="adana">Adana</option>
                                    <option value="kocaeli">Kocaeli</option>
                                    <option value="sanliurfa">Şanlıurfa</option>
                                    <option value="diyarbakir">Diyarbakır</option>
                                    <option value="elazig">Elazığ</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">İşlem:</label>
                                <button class="btn btn-success w-100" id="analyzeBtn" onclick="startAnalysis()" disabled>
                                    <i class="fas fa-play"></i> Analizi Başlat
                                </button>
                            </div>
                        </div>

                        <!-- Durum Göstergeleri -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div id="statusContainer" style="display: none;">
                                    <div class="alert alert-info">
                                        <div class="d-flex align-items-center">
                                            <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                                            <div>
                                                <strong>Analiz devam ediyor...</strong>
                                                <div id="statusText" class="small">Veri çekiliyor...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Özet İstatistikler -->
                        <div id="summaryStats" class="row mb-3 p-2" style="display: none;"></div>

                        <!-- Koşu Sonuçları -->
                        <div id="results" class="race-results"></div>
                    </div>
                </div>

                <!-- Karşılaştırma Sonuçları -->
                <div id="comparisonContainer" style="display: none;">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="fas fa-balance-scale"></i> Tahmin vs Gerçek Sonuçlar</h5>
                        </div>
                        <div class="card-body">
                            <div id="comparisonResults"></div>
                        </div>
                    </div>
                </div>

                <!-- Dünkü Sonuçlar -->
                <div id="yesterdayContainer" style="display: none;">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-calendar-day"></i> Dünkü Koşu Sonuçları</h5>
                        </div>
                        <div class="card-body">
                            <div id="yesterdayResults"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Yan Panel -->
            <div class="col-lg-4">
                <!-- Hızlı İstatistikler -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-tachometer-alt"></i> Hızlı İstatistikler</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <h4 class="text-primary mb-1">9</h4>
                                <small class="text-muted">Şehir</small>
                            </div>
                            <div class="col-6 mb-3">
                                <h4 class="text-success mb-1">%77.3</h4>
                                <small class="text-muted">Başarı Oranı</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-warning mb-1" id="analysisCount">{{ current_user.daily_analysis_count or 0 }}</h4>
                                <small class="text-muted">Günlük Analiz</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-info mb-1">{{ current_user.total_predictions or 0 }}</h4>
                                <small class="text-muted">Toplam Tahmin</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Son İşlemler -->
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0"><i class="fas fa-history"></i> Son İşlemler</h6>
                    </div>
                    <div class="card-body">
                        <div id="recentAnalyses">
                            <p class="text-muted small">Henüz analiz yapılmamış.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Premium kontrol için JavaScript güncellemesi
document.addEventListener('DOMContentLoaded', function() {
    // URL'den analiz parametrelerini kontrol et
    const urlParams = new URLSearchParams(window.location.search);
    const analysisDone = urlParams.get('analysis_done');
    const city = urlParams.get('city');
    
    if (analysisDone === 'true' && city) {
        // Şehiri seç ve analizi göster
        const citySelect = document.getElementById('citySelect');
        if (citySelect) {
            citySelect.value = city;
            updateAnalysisInfo();
            loadSavedAnalysis();
        }
    }
    
    // Counter animasyonu
    animateCounters();
    
    // Smooth scroll
    smoothScroll();
});

// Şehir seçimi güncelleme
function updateAnalysisInfo() {
    const citySelect = document.getElementById('citySelect');
    const analyzeBtn = document.getElementById('analyzeBtn');
    
    if (citySelect && analyzeBtn) {
        analyzeBtn.disabled = !citySelect.value;
    }
}

// Analiz başlatma
function startAnalysis() {
    const citySelect = document.getElementById('citySelect');
    const selectedCity = citySelect.value;
    
    if (!selectedCity) {
        alert('Lütfen bir şehir seçin!');
        return;
    }
    
    // Premium kontrolü
    if (!window.isPremium && window.dailyAnalysisCount >= 3) {
        if (confirm('Günlük ücretsiz analiz hakkınız doldu. Premium üyelik satın almak ister misiniz?')) {
            window.location.href = '/auth/premium';
            return;
        } else {
            return;
        }
    }
    
    // Analiz başlat
    showStatus('Analiz başlatılıyor...');
    
    fetch('/api/scrape_city', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            city: selectedCity
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResults(data);
            updateAnalysisCount();
        } else {
            showError(data.error || 'Analiz sırasında bir hata oluştu.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Bir hata oluştu. Lütfen tekrar deneyin.');
    })
    .finally(() => {
        hideStatus();
    });
}

// Kaydedilmiş analizi yükle
function loadSavedAnalysis() {
    const citySelect = document.getElementById('citySelect');
    const selectedCity = citySelect.value;
    
    if (!selectedCity) return;
    
    showStatus('Kaydedilmiş veriler yükleniyor...');
    
    fetch('/api/calculate_from_saved', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            city: selectedCity
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResults(data);
        } else {
            console.log('Kaydedilmiş veri bulunamadı:', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    })
    .finally(() => {
        hideStatus();
    });
}

// Durum gösterme
function showStatus(message) {
    const statusContainer = document.getElementById('statusContainer');
    const statusText = document.getElementById('statusText');
    
    if (statusContainer && statusText) {
        statusText.textContent = message;
        statusContainer.style.display = 'block';
    }
}

// Durum gizleme
function hideStatus() {
    const statusContainer = document.getElementById('statusContainer');
    if (statusContainer) {
        statusContainer.style.display = 'none';
    }
}

// Sonuçları gösterme
function showResults(data) {
    const resultsContainer = document.getElementById('results');
    const summaryContainer = document.getElementById('summaryStats');
    
    if (!resultsContainer) return;
    
    // Özet istatistikleri göster
    if (summaryContainer && data.summary) {
        summaryContainer.innerHTML = `
            <div class="col-md-3 text-center">
                <h4 class="text-primary">${data.summary.total_races || 0}</h4>
                <small class="text-muted">Toplam Koşu</small>
            </div>
            <div class="col-md-3 text-center">
                <h4 class="text-success">${data.summary.total_horses || 0}</h4>
                <small class="text-muted">Toplam At</small>
            </div>
            <div class="col-md-3 text-center">
                <h4 class="text-warning">${data.summary.avg_score || 0}%</h4>
                <small class="text-muted">Ortalama Skor</small>
            </div>
            <div class="col-md-3 text-center">
                <h4 class="text-info">${data.city_name || ''}</h4>
                <small class="text-muted">Analiz Edilen Şehir</small>
            </div>
        `;
        summaryContainer.style.display = 'flex';
    }
    
    // Koşu sonuçlarını göster
    if (data.races && data.races.length > 0) {
        let html = '<h5 class="mb-3">Koşu Analizleri</h5>';
        
        data.races.forEach((race, index) => {
            html += `
                <div class="race-card card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">${race.race_number || (index + 1)}. Koşu - ${race.distance || 'Bilinmiyor'} - ${race.track_condition || 'Bilinmiyor'}</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Sıra</th>
                                        <th>At Adı</th>
                                        <th>Skor</th>
                                        <th>Durum</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            if (race.horses && race.horses.length > 0) {
                race.horses.forEach((horse, horseIndex) => {
                    const statusClass = horseIndex === 0 ? 'success' : horseIndex < 3 ? 'warning' : 'secondary';
                    const statusText = horseIndex === 0 ? 'Güçlü Aday' : horseIndex < 3 ? 'Aday' : 'Zayıf';
                    
                    html += `
                        <tr>
                            <td><span class="badge bg-${statusClass}">${horseIndex + 1}</span></td>
                            <td><strong>${horse.name || 'Bilinmiyor'}</strong></td>
                            <td><span class="badge bg-primary">${(horse.score || 0).toFixed(1)}</span></td>
                            <td><span class="text-${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                });
            } else {
                html += '<tr><td colspan="4" class="text-center">At bilgisi bulunamadı.</td></tr>';
            }
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        });
        
        // CSV indirme butonu ekle
        if (data.csv_filename) {
            html += `
                <div class="text-center mt-3">
                    <a href="/static/downloads/${data.csv_filename}" class="btn btn-success" download>
                        <i class="fas fa-download"></i> Excel Dosyasını İndir
                    </a>
                </div>
            `;
        }
        
        resultsContainer.innerHTML = html;
    } else {
        resultsContainer.innerHTML = '<div class="alert alert-warning">Bu şehir için koşu verisi bulunamadı.</div>';
    }
}

// Hata gösterme
function showError(message) {
    const resultsContainer = document.getElementById('results');
    if (resultsContainer) {
        resultsContainer.innerHTML = `<div class="alert alert-danger">${message}</div>`;
    }
}

// Analiz sayısını güncelle
function updateAnalysisCount() {
    const countElement = document.getElementById('analysisCount');
    if (countElement && window.dailyAnalysisCount !== undefined) {
        window.dailyAnalysisCount++;
        countElement.textContent = window.dailyAnalysisCount;
    }
}

// Counter animasyonu
function animateCounters() {
    const counters = document.querySelectorAll('.counter');
    
    counters.forEach(counter => {
        const target = parseInt(counter.getAttribute('data-target'));
        const duration = 2000;
        const step = target / (duration / 16);
        let current = 0;
        
        const timer = setInterval(() => {
            current += step;
            if (current >= target) {
                current = target;
                clearInterval(timer);
            }
            
            if (counter.textContent.includes('%')) {
                counter.textContent = Math.floor(current) + '%';
            } else if (counter.textContent.includes('+')) {
                counter.textContent = Math.floor(current) + '+';
            } else {
                counter.textContent = Math.floor(current);
            }
        }, 16);
    });
}

// Sayfa scroll animasyonu
function smoothScroll() {
    const links = document.querySelectorAll('a[href^="#"]');
    links.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth'
                });
            }
        });
    });
}
</script>
{% endblock %}