{% extends "base.html" %}

{% block content %}
<!-- Global JavaScript deÄŸiÅŸkenleri -->
<script>
window.isPremium = {{ 'true' if is_premium else 'false' }};
window.dailyAnalysisCount = {{ current_user.daily_analysis_count or 0 }};
</script>

<!-- KullanÄ±cÄ± KarÅŸÄ±lama -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="card-body text-white">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="mb-1">HoÅŸ geldiniz, {{ current_user.first_name }}!</h2>
                        <p class="mb-0 lead"></p>
                    </div>
                    <div class="col-md-4 text-end">
                        {% if is_premium %}
                            <span class="badge bg-warning text-dark fs-6 p-2">
                                <i class="fas fa-crown"></i> Premium Ãœye
                            </span>
                            <div class="small mt-1">{{ premium_days_left }} gÃ¼n kaldÄ±</div>
                        {% else %}
                            <a href="{{ url_for('auth.premium') }}" class="btn btn-warning btn-lg">
                                <i class="fas fa-crown"></i> Premium Ol
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ä°statistik KartlarÄ± -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ recent_analyses|length }}</h4>
                        <p class="mb-0">Toplam Analiz</p>
                    </div>
                    <div>
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{% if is_premium %}Aktif{% else %}Pasif{% endif %}</h4>
                        <p class="mb-0">Premium Durum</p>
                    </div>
                    <div>
                        <i class="fas fa-{% if is_premium %}crown{% else %}lock{% endif %} fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ current_user.created_at.strftime('%d.%m.%Y') }}</h4>
                        <p class="mb-0">Ãœyelik Tarihi</p>
                    </div>
                    <div>
                        <i class="fas fa-calendar fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{% if is_premium %}{{ current_user.daily_analysis_count or 0 }}/10{% else %}{{ current_user.daily_analysis_count or 0 }}/2{% endif %}</h4>
                        <p class="mb-0">{% if is_premium %}GÃ¼nlÃ¼k Analiz{% else %}Toplam Analiz{% endif %}</p>
                    </div>
                    <div>
                        <i class="fas fa-{% if is_premium %}infinity{% else %}chart-bar{% endif %} fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Ana Ä°Ã§erik -->
<div class="row">
    <!-- Sol Kolon - HÄ±zlÄ± Ä°ÅŸlemler -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-bolt"></i> HÄ±zlÄ± Ä°ÅŸlemler</h5>
            </div>
            <div class="card-body">
                {% if is_premium %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> <strong>Premium aktif!</strong> TÃ¼m Ã¶zellikleri kullanabilirsiniz.
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4 col-6">
                            <button class="btn btn-primary w-100 p-3" onclick="showCitySelection()">
                                <i class="fas fa-chart-line fa-2x d-block mb-2"></i>
                                <strong>Analiz Yap</strong>
                                <div class="small">Åžehir seÃ§ ve analiz et</div>
                            </button>
                        </div>
                        <div class="col-md-4 col-6">
                            <button class="btn btn-danger w-100 p-3" onclick="showAnalysisResults()">
                                <i class="fas fa-list-alt fa-2x d-block mb-2"></i>
                                <strong>Analizleri GÃ¶r</strong>
                                <div class="small">SonuÃ§larÄ± incele</div>
                            </button>
                        </div>
                        <div class="col-md-4 col-6">
                            <a href="{{ url_for('auth.profile') }}" class="btn btn-info w-100 p-3">
                                <i class="fas fa-user-cog fa-2x d-block mb-2"></i>
                                <strong>Profil AyarlarÄ±</strong>
                                <div class="small">Hesap bilgileri</div>
                            </a>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Ãœcretsiz KullanÄ±cÄ±!</strong> 
                        Toplam 2 analiz hakkÄ±nÄ±z bulunmaktadÄ±r.
                    </div>
                    <div class="row g-3">
                        <div class="col-md-3 col-6">
                            <button class="btn btn-primary w-100 p-3" onclick="showCitySelection()">
                                <i class="fas fa-chart-line fa-2x d-block mb-2"></i>
                                <strong>Analiz Yap</strong>
                                <div class="small">Åžehir seÃ§ ve analiz et</div>
                            </button>
                        </div>
                        <div class="col-md-3 col-6">
                            <button class="btn btn-danger w-100 p-3" onclick="showAnalysisResults()">
                                <i class="fas fa-list-alt fa-2x d-block mb-2"></i>
                                <strong>Analizleri GÃ¶r</strong>
                                <div class="small">SonuÃ§larÄ± incele</div>
                            </button>
                        </div>
                        <div class="col-md-3 col-6">
                            <a href="{{ url_for('auth.premium') }}" class="btn btn-success w-100 p-3">
                                <i class="fas fa-crown fa-2x d-block mb-2"></i>
                                <strong>Premium Ol</strong>
                                <div class="small">GÃ¼nde 10 analiz</div>
                            </a>
                        </div>
                        <div class="col-md-3 col-6">
                            <a href="{{ url_for('auth.profile') }}" class="btn btn-info w-100 p-3">
                                <i class="fas fa-user-cog fa-2x d-block mb-2"></i>
                                <strong>Profil AyarlarÄ±</strong>
                                <div class="small">Hesap bilgileri</div>
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Son Analizler -->
        {% if recent_analyses %}
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Son Analizlerim</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Tarih</th>
                                <th>Åžehir</th>
                                <th>TÃ¼r</th>
                                <th>BaÅŸarÄ± OranÄ±</th>
                                <th>KoÅŸu SayÄ±sÄ±</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for analysis in recent_analyses %}
                            <tr>
                                <td>{{ analysis.analysis_date.strftime('%d.%m.%Y %H:%M') }}</td>
                                <td><span class="badge bg-primary">{{ analysis.city.title() }}</span></td>
                                <td>{{ analysis.analysis_type.title() }}</td>
                                <td>
                                    {% if analysis.success_rate %}
                                        <span class="badge bg-{% if analysis.success_rate >= 70 %}success{% elif analysis.success_rate >= 50 %}warning{% else %}danger{% endif %}">
                                            {{ "%.1f"|format(analysis.success_rate) }}%
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ analysis.race_count or analysis.total_races or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- SaÄŸ Kolon - Bilgiler -->
    <div class="col-md-4">
        <!-- Premium Bilgisi -->
        <div class="card mb-3">
            <div class="card-header bg-{% if is_premium %}success{% else %}warning{% endif %} text-white">
                <h6 class="mb-0"><i class="fas fa-crown"></i> Premium Ãœyelik</h6>
            </div>
            <div class="card-body">
                {% if is_premium %}
                    <div class="text-center">
                        <i class="fas fa-crown fa-3x text-warning mb-2"></i>
                        <h5 class="text-success">Aktif</h5>
                        <p class="mb-2">{{ premium_days_left }} gÃ¼n kaldÄ±</p>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: {{ (premium_days_left / 30 * 100) if premium_days_left <= 30 else 100 }}%"></div>
                        </div>
                        {% if current_user.premium_end_date %}
                        <small class="text-muted">{{ current_user.premium_end_date.strftime('%d.%m.%Y') }} tarihinde sona eriyor</small>
                        {% else %}
                        <small class="text-muted">Premium bitiÅŸ tarihi belirtilmemiÅŸ</small>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="text-center">
                        <i class="fas fa-lock fa-3x text-muted mb-2"></i>
                        <h5 class="text-muted">Pasif</h5>
                        <p class="mb-3">Premium Ã¶zelliklerine eriÅŸmek iÃ§in Ã¼ye olun</p>
                        <a href="{{ url_for('auth.premium') }}" class="btn btn-warning btn-sm">
                            <i class="fas fa-crown"></i> Premium Ol
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Sistem DuyurularÄ± -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-bell"></i> Sistem Bilgileri</h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info alert-sm">
                    <i class="fas fa-info-circle"></i> <strong>Yeni Ã–zellik:</strong> 
                    SonuÃ§ karÅŸÄ±laÅŸtÄ±rma sistemi aktif! 
                </div>
                <div class="alert alert-success alert-sm">
                    <i class="fas fa-chart-line"></i> <strong>BaÅŸarÄ± OranÄ±:</strong> 
                    Sistemin ortalama baÅŸarÄ± oranÄ± %77.3
                </div>
                <div class="alert alert-warning alert-sm">
                    <i class="fas fa-clock"></i> <strong>Analiz Limiti:</strong> 
                    Premium Ã¼yeler gÃ¼nde 10, Ã¼cretsiz kullanÄ±cÄ±lar toplam 2 analiz yapabilir
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Åžehir SeÃ§imi Modal -->
<div class="modal fade" id="citySelectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Analiz iÃ§in Åžehir SeÃ§in</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2">
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary w-100 city-btn" data-city="istanbul">
                            <i class="fas fa-city"></i> Ä°stanbul
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary w-100 city-btn" data-city="ankara">
                            <i class="fas fa-building"></i> Ankara
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary w-100 city-btn" data-city="izmir">
                            <i class="fas fa-water"></i> Ä°zmir
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary w-100 city-btn" data-city="bursa">
                            <i class="fas fa-mountain"></i> Bursa
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary w-100 city-btn" data-city="adana">
                            <i class="fas fa-sun"></i> Adana
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary w-100 city-btn" data-city="kocaeli">
                            <i class="fas fa-industry"></i> Kocaeli
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary w-100 city-btn" data-city="sanliurfa">
                            <i class="fas fa-mosque"></i> ÅžanlÄ±urfa
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary w-100 city-btn" data-city="diyarbakir">
                            <i class="fas fa-landmark"></i> DiyarbakÄ±r
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary w-100 city-btn" data-city="elazig">
                            <i class="fas fa-tree"></i> ElazÄ±ÄŸ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SonuÃ§ karÅŸÄ±laÅŸtÄ±rma Ã¶zelliÄŸi kaldÄ±rÄ±ldÄ± -->

<!-- NasÄ±l KullanÄ±lÄ±r - AÃ§Ä±lÄ±r KapanÄ±r BÃ¶lÃ¼m -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card how-to-use-card">
            <div class="card-header text-white" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#howToUseCollapse" aria-expanded="false" aria-controls="howToUseCollapse">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-question-circle"></i> NasÄ±l KullanÄ±lÄ±r?</h5>
                    <i class="fas fa-chevron-down collapse-icon"></i>
                </div>
            </div>
            <div class="collapse" id="howToUseCollapse">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="step-item">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h6>Åžehir SeÃ§in</h6>
                                    <p>Analiz yapmak istediÄŸiniz ÅŸehri seÃ§in. 9 farklÄ± ÅŸehirden gÃ¼ncel veriler Ã§ekiyoruz.</p>
                                </div>
                            </div>
                            <div class="step-item">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h6>Analiz BaÅŸlatÄ±n</h6>
                                    <p>"Analiz Yap" butonuna tÄ±klayarak yapay zeka destekli analiz sÃ¼recini baÅŸlatÄ±n.</p>
                                </div>
                            </div>
                            <div class="step-item">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h6>SonuÃ§larÄ± Ä°nceleyin</h6>
                                    <p>DetaylÄ± skor hesaplamalarÄ± ve koÅŸu sÄ±ralamalarÄ± ile tahminlerinizi yapÄ±n.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="step-item">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h6>Excel'e AktarÄ±n</h6>
                                    <p>Analiz sonuÃ§larÄ±nÄ± CSV formatÄ±nda indirerek kendi stratejilerinizi geliÅŸtirin.</p>
                                </div>
                            </div>
                            <div class="step-item">
                                <div class="step-number">5</div>
                                <div class="step-content">
                                    <h6>SonuÃ§larÄ± KarÅŸÄ±laÅŸtÄ±rÄ±n</h6>
                                    <p>Tahminlerinizin doÄŸruluÄŸunu gerÃ§ek sonuÃ§larla karÅŸÄ±laÅŸtÄ±rarak baÅŸarÄ± oranÄ±nÄ±zÄ± takip edin.</p>
                                </div>
                            </div>
                            <div class="tip-box">
                                <i class="fas fa-lightbulb"></i>
                                <strong>Ä°pucu:</strong> Premium Ã¼yelikle gÃ¼nde 10 analiz yapabilir ve %77.3 ortalama baÅŸarÄ± oranÄ±ndan faydalanabilirsiniz!
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- YÃ¼kleme ModalÄ± -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">YÃ¼kleniyor...</span>
                </div>
                <p class="mt-3" id="loadingText">Ä°ÅŸleminiz gerÃ§ekleÅŸtiriliyor...</p>
            </div>
        </div>
    </div>
</div>

<!-- Analiz SonuÃ§larÄ± ModalÄ± -->
<div class="modal fade" id="analysisResultsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-list-alt me-2"></i>Analiz SonuÃ§larÄ±
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="analysisResultsContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Analiz sonuÃ§larÄ± yÃ¼kleniyor...</span>
                        </div>
                        <p class="mt-2">Analiz sonuÃ§larÄ± yÃ¼kleniyor...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Kapat
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Modal fonksiyonlarÄ±
function showCitySelection() {
    new bootstrap.Modal(document.getElementById('citySelectionModal')).show();
}

// SonuÃ§ karÅŸÄ±laÅŸtÄ±rma Ã¶zelliÄŸi kaldÄ±rÄ±ldÄ±

function showAnalysisResults() {
    // ModalÄ± gÃ¶ster
    const modal = new bootstrap.Modal(document.getElementById('analysisResultsModal'));
    modal.show();
    
    // Analiz sonuÃ§larÄ±nÄ± yÃ¼kle
    loadAnalysisResults();
}

function showLoading(text = 'Ä°ÅŸleminiz gerÃ§ekleÅŸtiriliyor...') {
    document.getElementById('loadingText').textContent = text;
    new bootstrap.Modal(document.getElementById('loadingModal')).show();
}

function hideLoading() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
    if (modal) modal.hide();
}

// Åžehir seÃ§imi
document.querySelectorAll('.city-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const city = this.dataset.city;
        const cityName = this.textContent.trim();
        
        bootstrap.Modal.getInstance(document.getElementById('citySelectionModal')).hide();
        
        // Analiz limiti kontrolÃ¼
        if (window.isPremium && window.dailyAnalysisCount >= 10) {
            alert('GÃ¼nlÃ¼k premium analiz limitiniz dolmuÅŸ (10/10). YarÄ±n tekrar deneyebilirsiniz.');
            return;
        } else if (!window.isPremium && window.dailyAnalysisCount >= 2) {
            alert('Ãœcretsiz analiz hakkÄ±nÄ±z dolmuÅŸ (2/2). Premium Ã¼yelikle gÃ¼nde 10 analiz yapabilirsiniz.');
            return;
        }
        
        showLoading(`${cityName} iÃ§in analiz yapÄ±lÄ±yor...`);
        
        fetch('/api/scrape_city', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({city: city})
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                // Ana sayfaya yÃ¶nlendir ve sonuÃ§larÄ± gÃ¶ster
                window.location.href = '/?analysis_done=true&city=' + city;
            } else {
                alert('Analiz sÄ±rasÄ±nda hata: ' + (data.error || 'Bilinmeyen hata'));
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            alert('BaÄŸlantÄ± hatasÄ±: ' + error.message);
        });
    });
});

// KarÅŸÄ±laÅŸtÄ±rma fonksiyonlarÄ± kaldÄ±rÄ±ldÄ±

// KarÅŸÄ±laÅŸtÄ±rma sonuÃ§ fonksiyonlarÄ± kaldÄ±rÄ±ldÄ±

// DÃ¼nkÃ¼ sonuÃ§ fonksiyonu kaldÄ±rÄ±ldÄ±

// Analiz sonuÃ§larÄ±nÄ± yÃ¼kle
async function loadAnalysisResults() {
    const content = document.getElementById('analysisResultsContent');
    
    try {
        // KullanÄ±labilir analiz dosyalarÄ±nÄ± getir
        const response = await fetch('/api/get_analysis_files');
        
        // Response status kontrol et
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('API Response:', data); // Debug iÃ§in
        
        // API hata dÃ¶ndÃ¼rmÃ¼ÅŸ mÃ¼ kontrol et
        if (!data.success) {
            throw new Error(data.error || 'API baÅŸarÄ±sÄ±z response dÃ¶ndÃ¼rdÃ¼');
        }
        
        let html = '';
        
        if (data.files && Object.keys(data.files).length > 0) {
            html = '<div class="row">';
            
            // Her ÅŸehir iÃ§in dosyalarÄ± listele
            for (const [city, files] of Object.entries(data.files)) {
                if (files.length > 0) {
                    html += `<div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>${city}</h6>
                            </div>
                            <div class="card-body">`;
                    
                    files.forEach(file => {
                        const isAnalysis = file.filename.includes('analiz') || file.filename.includes('hesaplamali');
                        
                        // Ham veriyi filtrele - sadece analiz sonuÃ§larÄ±nÄ± gÃ¶ster
                        if (!isAnalysis) {
                            return; // Ham veri dosyalarÄ±nÄ± atla
                        }
                        
                        const icon = 'fa-chart-line';
                        const badgeClass = 'bg-success';
                        const type = 'Analiz Sonucu';
                        
                        // Dosya isminden tarihi ve ÅŸehri Ã§Ä±kar ve gÃ¼zel formata Ã§evir
                        let displayName = file.filename;
                        const dateMatch = file.filename.match(/(\d{8})/); // YYYYMMDD formatÄ±
                        
                        // Åžehir ismini dosya adÄ±ndan Ã§Ä±kar
                        let cityName = 'Bilinmeyen';
                        if (file.filename.includes('istanbul')) cityName = 'Ä°stanbul';
                        else if (file.filename.includes('ankara')) cityName = 'Ankara';
                        else if (file.filename.includes('izmir')) cityName = 'Ä°zmir';
                        else if (file.filename.includes('bursa')) cityName = 'Bursa';
                        else if (file.filename.includes('adana')) cityName = 'Adana';
                        else if (file.filename.includes('kocaeli')) cityName = 'Kocaeli';
                        else if (file.filename.includes('sanliurfa')) cityName = 'ÅžanlÄ±urfa';
                        else if (file.filename.includes('diyarbakir')) cityName = 'DiyarbakÄ±r';
                        else if (file.filename.includes('elazig')) cityName = 'ElazÄ±ÄŸ';
                        
                        if (dateMatch) {
                            const dateStr = dateMatch[1];
                            const year = dateStr.substring(0, 4);
                            const month = dateStr.substring(4, 6);
                            const day = dateStr.substring(6, 8);
                            displayName = `${day}.${month}.${year} ${cityName} Bilgileri`;
                        }
                        
                        html += `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <i class="fas ${icon} text-primary"></i>
                                    <span class="ms-2">${displayName}</span>
                                    <span class="badge ${badgeClass} ms-2">${type}</span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1" 
                                            onclick="viewAnalysisFile('${file.filename}', '${city}')">
                                        <i class="fas fa-eye"></i> GÃ¶rÃ¼ntÃ¼le
                                    </button>
                                    <a href="/download/${file.filename}" class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-download"></i> Ä°ndir
                                    </a>
                                </div>
                            </div>`;
                    });
                    
                    html += '</div></div></div>';
                }
            }
            
            html += '</div>';
            
            if (Object.keys(data.files).length === 0) {
                html = '<div class="text-center py-4"><i class="fas fa-inbox fa-3x text-muted mb-3"></i><h5>HenÃ¼z analiz yapÄ±lmamÄ±ÅŸ</h5><p class="text-muted">Analiz yapmak iÃ§in "Analiz Yap" butonunu kullanÄ±n</p></div>';
            }
            
        } else {
            html = '<div class="text-center py-4"><i class="fas fa-inbox fa-3x text-muted mb-3"></i><h5>HenÃ¼z analiz yapÄ±lmamÄ±ÅŸ</h5><p class="text-muted">Analiz yapmak iÃ§in "Analiz Yap" butonunu kullanÄ±n</p></div>';
        }
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('Analiz sonuÃ§larÄ± yÃ¼klenirken hata:', error);
        content.innerHTML = `<div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> 
            <strong>Hata:</strong> ${error.message || 'Analiz sonuÃ§larÄ± yÃ¼klenirken hata oluÅŸtu.'}
            <br><small>Detay iÃ§in browser console'u kontrol edin.</small>
        </div>`;
    }
}

// Analiz dosyasÄ±nÄ± gÃ¶rÃ¼ntÃ¼le
async function viewAnalysisFile(filename, city) {
    console.log('ðŸš¨ RENK TESTÄ° - viewAnalysisFile Ã§alÄ±ÅŸÄ±yor!', filename);
    try {
        const response = await fetch(`/api/view_analysis_file/${filename}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const responseText = await response.text();
        console.log('Raw response:', responseText.substring(0, 200)); // Ä°lk 200 karakter
        
        let data;
        try {
            data = JSON.parse(responseText);
        } catch (jsonError) {
            console.error('JSON Parse Error:', jsonError);
            throw new Error(`JSON parsing hatasÄ±: ${jsonError.message}`);
        }
        
        if (!data.success) {
            throw new Error(data.error || 'API baÅŸarÄ±sÄ±z response dÃ¶ndÃ¼rdÃ¼');
        }
        
        if (data.data && data.data.length > 0) {
            const content = document.getElementById('analysisResultsContent');
            let html = `<div class="mb-3">
                <h6><i class="fas fa-file-alt me-2"></i>${filename}</h6>
                <button class="btn btn-sm btn-secondary" onclick="loadAnalysisResults()">
                    <i class="fas fa-arrow-left"></i> Geri DÃ¶n
                </button>
            </div>`;
            
            // Veriyi koÅŸulara gÃ¶re grupla
            if (data.data.length > 0) {
                const raceGroups = {};
                
                // Backend'de iÅŸlenmiÅŸ verileri koÅŸulara gÃ¶re grupla
                data.data.forEach(row => {
                    const race = row['KoÅŸu'] || 'Bilinmeyen KoÅŸu';
                    if (!raceGroups[race]) {
                        raceGroups[race] = [];
                    }
                    raceGroups[race].push(row);
                });
                
                console.log('Race Groups:', raceGroups);
                
                // KoÅŸu sekmeleri oluÅŸtur
                html += `<div class="mb-3">
                    <ul class="nav nav-pills nav-fill" id="raceTabs" role="tablist">`;
                
                let isFirst = true;
                Object.keys(raceGroups).forEach((race, index) => {
                    const raceId = `race-${index}`;
                    const activeClass = isFirst ? 'active' : '';
                    const raceCount = raceGroups[race].length;
                    
                    // KoÅŸu ismini temiz tut - saat bilgisi ekleme
                    let displayRace = race;
                    
                    html += `
                        <li class="nav-item" role="presentation">
                            <button class="nav-link ${activeClass}" id="${raceId}-tab" 
                                    data-bs-toggle="pill" data-bs-target="#${raceId}" 
                                    type="button" role="tab">
                                <strong>${displayRace}</strong>
                                <div class="small">${raceCount} At</div>
                            </button>
                        </li>`;
                    isFirst = false;
                });
                
                html += `</ul></div>`;
                
                // KoÅŸu iÃ§erikleri
                html += `<div class="tab-content" id="raceTabsContent">`;
                
                isFirst = true;
                Object.entries(raceGroups).forEach(([race, horses], index) => {
                    const raceId = `race-${index}`;
                    const activeClass = isFirst ? 'show active' : '';
                    
                    html += `
                        <div class="tab-pane fade ${activeClass}" id="${raceId}" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover race-table">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>N</th>
                                            <th>At Ä°smi</th>
                                            <th>Hipodrom</th>
                                            <th>Ã‡Ä±ktÄ±</th>
                                            <th>Mesafe</th>
                                            <th>Pist</th>
                                            <th>S.Kilo</th>
                                            <th>M.Kilo</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;
                    
                    horses.forEach((horse, horseIndex) => {
                        const skor = horse['Skor'] || horse['Score'] || '';
                        let skorClass = 'text-dark';
                        if (skor && !isNaN(skor)) {
                            const score = parseFloat(skor);
                            if (score >= 70) skorClass = 'text-success fw-bold';
                            else if (score >= 50) skorClass = 'text-warning fw-bold';
                            else if (score > 0) skorClass = 'text-danger';
                        }
                        
                        // SÄ±ralamaya gÃ¶re at ismi CSS class'Ä± belirle
                        const rank = horseIndex + 1;
                        let rankClass = 'rank-default';
                        if (rank === 1) {
                            rankClass = 'rank-1';
                        } else if (rank === 2 || rank === 3) {
                            rankClass = 'rank-2';
                        } else if (rank === 4 || rank === 5) {
                            rankClass = 'rank-4';
                        }
                        // Renk belirleme
                        let cellStyle = '';
                        let horseName = horse['At Ä°smi'] || horse['At Ismi'] || horse['Horse'] || '';
                        
                        if (rank === 1) {
                            cellStyle = 'style="color: #28a745 !important; font-weight: bold !important; background: #f8fff8;"';
                        } else if (rank === 2 || rank === 3) {
                            cellStyle = 'style="color: #007bff !important; font-weight: bold !important; background: #f8f9ff;"';
                        } else if (rank === 4 || rank === 5) {
                            cellStyle = 'style="color: #fd7e14 !important; font-weight: bold !important; background: #fffaf8;"';
                        } else {
                            cellStyle = 'style="color: #000000 !important; font-weight: bold !important;"';
                        }
                        
                        html += `
                            <tr>
                                <td>${rank}</td>
                                <td ${cellStyle}>${horseName}</td>
                                <td>${horse['Hipodrom'] || horse['Son Hipodrom'] || ''}</td>
                                <td>${horse['Ã‡Ä±ktÄ±'] || horse['Cikti'] || ''}</td>
                                <td>${horse['Mesafe'] || horse['Son Mesafe'] || horse['BugÃ¼nkÃ¼ Mesafe'] || ''}</td>
                                <td>${horse['Pist'] || horse['Son Pist'] || horse['BugÃ¼nkÃ¼ Pist'] || ''}</td>
                                <td>${horse['S.Kilo'] || horse['Son Kilo'] || ''}</td>
                                <td>${horse['M.Kilo'] || horse['Kilo'] || ''}</td>
                            </tr>`;
                    });
                    
                    html += `</tbody></table></div></div>`;
                    isFirst = false;
                });
                
                html += `</div>`;
                
                if (data.data.length > 50) {
                    html += `<div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        Toplam ${data.data.length} kayÄ±t var, ilk 50'si gÃ¶steriliyor. 
                        TÃ¼m verileri gÃ¶rmek iÃ§in dosyayÄ± indirin.
                    </div>`;
                }
            }
            
            content.innerHTML = html;
        } else {
            content.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Dosya iÃ§eriÄŸi okunamadÄ±.</div>';
        }
        
    } catch (error) {
        console.error('Dosya gÃ¶rÃ¼ntÃ¼lenirken hata:', error);
        document.getElementById('analysisResultsContent').innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Dosya gÃ¶rÃ¼ntÃ¼lenirken hata oluÅŸtu.</div>';
    }
}

// Tarih formatlama fonksiyonu
function formatFileDate(dateString) {
    try {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        
        if (days === 0) {
            return 'BugÃ¼n';
        } else if (days === 1) {
            return 'DÃ¼n';
        } else if (days < 7) {
            return `${days} gÃ¼n Ã¶nce`;
        } else {
            return date.toLocaleDateString('tr-TR');
        }
    } catch (e) {
        return dateString;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Premium kalan gÃ¼n animasyonu
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
        setTimeout(() => {
            progressBar.style.transition = 'width 2s ease-in-out';
        }, 500);
    }
});
</script>
{% endblock %}