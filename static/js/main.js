document.addEventListener('DOMContentLoaded', function() {
    console.log('üèá At Yarƒ±≈üƒ± Analizi ba≈ülatƒ±lƒ±yor...');

    // DOM elementleri
    const citySelect = document.getElementById('citySelect');
    const checkDataBtn = document.getElementById('checkDataBtn');
    const scrapeAndSaveBtn = document.getElementById('scrapeAndSaveBtn');
    const quickCalculateBtn = document.getElementById('quickCalculateBtn');
    const scrapeBtn = document.getElementById('scrapeBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const statusMessage = document.getElementById('statusMessage');
    const resultsContainer = document.getElementById('resultsContainer');
    const summaryStats = document.getElementById('summaryStats');
    const results = document.getElementById('results');

    let currentData = null;

    // ≈ûehir se√ßimi deƒüi≈ütiƒüinde butonlarƒ± aktif et
    citySelect.addEventListener('change', function() {
        const hasCity = this.value !== '';
        checkDataBtn.disabled = !hasCity;
        scrapeAndSaveBtn.disabled = !hasCity;
        quickCalculateBtn.disabled = !hasCity;
        scrapeBtn.disabled = !hasCity;
    });

    // Y√ºkleme g√∂stergesi
    function showLoading(show, message = 'ƒ∞≈ülem yapƒ±lƒ±yor...') {
        if (show) {
            statusMessage.innerHTML = `
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        <span>${message}</span>
                    </div>
                </div>
            `;
        } else {
            statusMessage.innerHTML = '';
        }
    }

    // Durum mesajƒ± g√∂ster
    function showStatus(message, type = 'info') {
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'danger' ? 'alert-danger' : 
                          type === 'warning' ? 'alert-warning' : 'alert-info';
        
        statusMessage.innerHTML = `
            <div class="alert ${alertClass}" role="alert">
                ${message}
            </div>
        `;
    }

    // √ñzet istatistikler g√∂ster
    function showSummaryStats(data) {
        const totalHorses = data.total_horses;
        const validHorses = data.valid_horses;
        const successRate = data.success_rate;
        
        summaryStats.innerHTML = `
            <div class="col-md-3">
                <div class="stats-card">
                    <span class="stats-number">${totalHorses}</span>
                    <small>Toplam At</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <span class="stats-number">${validHorses}</span>
                    <small>Ge√ßerli Veri</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <span class="stats-number">%${successRate}</span>
                    <small>Ba≈üarƒ± Oranƒ±</small>
                </div>
            </div>
        `;
        summaryStats.style.display = 'flex';
    }

    // Pist t√ºr√º mapping
    function getPistType(pistCode) {
        const pistMap = {
            '1': '√áim',
            '2': 'Kum', 
            '3': 'Sentetik',
            '√áim': '√áim',
            'Kum': 'Kum',
            'Sentetik': 'Sentetik',
            '√ßim': '√áim',
            'kum': 'Kum',
            'sentetik': 'Sentetik'
        };
        return pistMap[pistCode] || pistCode || '-';
    }

    // Ko≈üu sonu√ßlarƒ±nƒ± g√∂ster
    function showRaceResults(data) {
        console.log('üìä Sonu√ßlar g√∂steriliyor...');
        
        let tabsHtml = '<div class="race-tabs-container"><div class="race-tabs">';
        let contentHtml = '<div class="race-content-container">';

        // Her ko≈üu i√ßin sekme ve i√ßerik olu≈ütur
        data.races.forEach((race, index) => {
            const raceNumber = index + 1;
            const validHorses = race.horses.filter(h => h.skor !== null && h.skor !== 'Veri yok');
            
            // Ko≈üu saati hesapla (16:45'ten ba≈ülayarak her ko≈üu 30dk sonra)
            const startHour = 16;
            const startMinute = 45;
            const totalMinutes = startMinute + (index * 30);
            const raceHour = startHour + Math.floor(totalMinutes / 60);
            const raceMinute = totalMinutes % 60;
            const raceTime = `${raceHour}:${raceMinute.toString().padStart(2, '0')}`;
            
            // Sekme
            tabsHtml += `
                <button class="race-tab ${index === 0 ? 'active' : ''}" onclick="showRaceTab(${index})" id="tab-${index}">
                    ${raceNumber}. Ko≈üu ${raceTime}
                </button>
            `;

            // ƒ∞√ßerik
            contentHtml += `
                <div class="race-content-tab ${index === 0 ? 'active' : ''}" id="race-tab-content-${index}">
                    <!-- Ana Tablo -->
                    <div class="table-responsive">
                        <table class="horse-table">
                            <thead>
                                <tr>
                                    <th width="30">N</th>
                                    <th width="150">At ƒ∞smi</th>
                                    <th width="100">Son Hipodrom</th>
                                    <th width="60">100m √áƒ±ktƒ±</th>
                                    <th width="80">Son Mesafe</th>
                                    <th width="60">Pist T√ºr√º</th>
                                    <th width="60">Son Kilo</th>
                                    <th width="60">Mevcut Kilo</th>
                                    <th width="60">Son Derece</th>
                                    <th width="80">Analiz Skoru</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            // Atlarƒ± skora g√∂re sƒ±rala (en d√º≈ü√ºk skordan en y√ºkseƒüe - en iyi 1.)
            const sortedHorses = [...race.horses].sort((a, b) => {
                const scoreA = typeof a.skor === 'number' ? a.skor : 9999;
                const scoreB = typeof b.skor === 'number' ? b.skor : 9999;
                return scoreA - scoreB; // En d√º≈ü√ºk skor en iyi (1.)
            });

            sortedHorses.forEach((horse, horseIndex) => {
                const rank = horseIndex + 1;
                const scoreText = typeof horse.skor === 'number' ? horse.skor.toFixed(2) : '-';

                contentHtml += `
                    <tr>
                        <td><strong>${rank}</strong></td>
                        <td class="horse-name"><strong>${horse.at_adi || 'Bilinmiyor'}</strong></td>
                        <td style="font-size: 10px;">${horse.son_hipodrom || '-'}</td>
                        <td><strong style="color: ${typeof horse.skor === 'number' ? '#28a745' : '#dc3545'}">${scoreText}</strong></td>
                        <td>${horse.son_mesafe || '-'}m</td>
                        <td>${getPistType(horse.son_pist)}</td>
                        <td>${horse.son_kilo || '-'}kg</td>
                        <td>${horse.agirlik || '-'}kg</td>
                        <td>${horse.son_derece || '-'}</td>
                        <td><strong style="color: ${typeof horse.skor === 'number' ? '#007bff' : '#6c757d'}">${scoreText}</strong></td>
                    </tr>
                `;
            });

            contentHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        });

        // "T√ºm Ko≈üular" sekmesi ekle
        tabsHtml += `
            <button class="race-tab" onclick="showAllRaces()" id="tab-all">
                T√ºm Ko≈üular
            </button>
        `;
        
        // T√ºm ko≈üular i√ßeriƒüi
        contentHtml += `
            <div class="race-content-tab" id="race-tab-content-all">
                <div class="row all-races-grid">
        `;
        
        data.races.forEach((race, index) => {
            const raceNumber = index + 1;
            const validHorses = race.horses.filter(h => h.skor !== null && h.skor !== 'Veri yok');
            const topHorse = race.horses.sort((a, b) => {
                const scoreA = typeof a.skor === 'number' ? a.skor : 9999;
                const scoreB = typeof b.skor === 'number' ? b.skor : 9999;
                return scoreA - scoreB; // En d√º≈ü√ºk skor en iyi
            })[0];
            
            const startHour = 16;
            const startMinute = 45;
            const totalMinutes = startMinute + (index * 30);
            const raceHour = startHour + Math.floor(totalMinutes / 60);
            const raceMinute = totalMinutes % 60;
            const raceTime = `${raceHour}:${raceMinute.toString().padStart(2, '0')}`;
            
            contentHtml += `
                <div class="col-md-4 col-sm-6 mb-3">
                    <div class="race-overview-card">
                        <h6>${raceNumber}. Ko≈üu ${raceTime}</h6>
                        <p class="card-text">
                            <strong>En ƒ∞yi:</strong> ${topHorse?.at_adi || 'Veri yok'}<br>
                            <strong>Skor:</strong> ${typeof topHorse?.skor === 'number' ? topHorse.skor.toFixed(2) : 'Veri yok'}<br>
                            <strong>Atlar:</strong> ${race.horses.length} / Ge√ßerli: ${validHorses.length}
                        </p>
                        <button class="btn btn-primary btn-sm" onclick="showRaceTab(${index})">
                            Detay G√∂r
                        </button>
                    </div>
                </div>
            `;
        });
        
        contentHtml += `
                </div>
            </div>
        `;

        tabsHtml += '</div></div>';
        contentHtml += '</div>';

        results.innerHTML = tabsHtml + contentHtml;
    }

    // Ko≈üu sekmesi g√∂ster
    window.showRaceTab = function(raceIndex) {
        // T√ºm sekmeleri pasif yap
        document.querySelectorAll('.race-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.race-content-tab').forEach(content => {
            content.classList.remove('active');
        });
        
        // Se√ßili sekmeyi aktif yap
        document.getElementById(`tab-${raceIndex}`).classList.add('active');
        document.getElementById(`race-tab-content-${raceIndex}`).classList.add('active');
    };

    // T√ºm ko≈üularƒ± g√∂ster
    window.showAllRaces = function() {
        // T√ºm sekmeleri pasif yap
        document.querySelectorAll('.race-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.race-content-tab').forEach(content => {
            content.classList.remove('active');
        });
        
        // "T√ºm Ko≈üular" sekmesini aktif yap
        document.getElementById('tab-all').classList.add('active');
        document.getElementById('race-tab-content-all').classList.add('active');
    };

    // Veri kontrol butonu
    checkDataBtn.addEventListener('click', async function() {
        const city = citySelect.value;
        if (!city) {
            showStatus('‚ùå L√ºtfen bir ≈üehir se√ßin!', 'warning');
            return;
        }

        showLoading(true, 'Kaydedilmi≈ü veriler kontrol ediliyor...');

        try {
            const response = await fetch('/api/check_saved_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ city: city })
            });

            const result = await response.json();

            if (response.ok && result.has_data) {
                showStatus(`
                    ‚úÖ ${result.data.city} i√ßin bug√ºnk√º veri mevcut!<br>
                    üìä Toplam ${result.data.total_horses} at, ${result.data.successful_horses} ba≈üarƒ±lƒ± veri<br>
                    üìà Ba≈üarƒ± oranƒ±: %${result.data.success_rate}
                `, 'success');
                
                quickCalculateBtn.disabled = false;
                downloadBtn.disabled = false;
            } else {
                showStatus(`‚ùå ${result.message}`, 'warning');
                quickCalculateBtn.disabled = true;
            }
        } catch (error) {
            showStatus('‚ùå Veri kontrol√º sƒ±rasƒ±nda hata olu≈ütu: ' + error.message, 'danger');
        } finally {
            showLoading(false);
        }
    });

    // Veri √ßekme butonu
    scrapeAndSaveBtn.addEventListener('click', async function() {
        const city = citySelect.value;
        if (!city) {
            showStatus('‚ùå L√ºtfen bir ≈üehir se√ßin!', 'warning');
            return;
        }

        showLoading(true, 'Veriler √ßekiliyor ve kaydediliyor...');

        try {
            const response = await fetch('/api/scrape_and_save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ city: city, debug: false })
            });

            const result = await response.json();

            if (response.ok) {
                showStatus(`
                    ‚úÖ ${result.data.city} verileri ba≈üarƒ±yla √ßekildi!<br>
                    üìä Toplam ${result.data.total_horses} at, ${result.data.successful_horses} ba≈üarƒ±lƒ± veri<br>
                    üìà Ba≈üarƒ± oranƒ±: %${result.data.success_rate}<br>
                    üíæ Ham veri: <a href="${result.data.raw_download_url}" class="alert-link">${result.data.raw_filename}</a>
                `, 'success');
                
                quickCalculateBtn.disabled = false;
            } else {
                showStatus('‚ùå Veri √ßekme hatasƒ±: ' + (result.message || 'Bilinmeyen hata'), 'danger');
            }
        } catch (error) {
            showStatus('‚ùå Veri √ßekme sƒ±rasƒ±nda hata olu≈ütu: ' + error.message, 'danger');
        } finally {
            showLoading(false);
        }
    });

    // Hƒ±zlƒ± hesaplama butonu
    quickCalculateBtn.addEventListener('click', async function() {
        const city = citySelect.value;
        if (!city) {
            showStatus('‚ùå L√ºtfen bir ≈üehir se√ßin!', 'warning');
            return;
        }

        showLoading(true, 'Kaydedilmi≈ü verilerle analiz yapƒ±lƒ±yor...');

        try {
            const response = await fetch('/api/calculate_from_saved', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ city: city })
            });

            const result = await response.json();

            if (response.ok) {
                currentData = result;
                showSummaryStats(result);
                showRaceResults(result);
                resultsContainer.style.display = 'block';
                downloadBtn.disabled = false;
                showStatus('‚úÖ Analiz tamamlandƒ±! Ko≈üulara tƒ±klayarak detaylarƒ± g√∂r√ºnt√ºleyebilirsiniz.', 'success');
            } else {
                showStatus('‚ùå Analiz hatasƒ±: ' + (result.message || 'Bilinmeyen hata'), 'danger');
            }
        } catch (error) {
            showStatus('‚ùå Analiz sƒ±rasƒ±nda hata olu≈ütu: ' + error.message, 'danger');
        } finally {
            showLoading(false);
        }
    });

    // √áek ve analiz butonu
    scrapeBtn.addEventListener('click', async function() {
        const city = citySelect.value;
        if (!city) {
            showStatus('‚ùå L√ºtfen bir ≈üehir se√ßin!', 'warning');
            return;
        }

        showLoading(true, 'Veriler √ßekiliyor ve analiz yapƒ±lƒ±yor...');

        try {
            const response = await fetch('/api/scrape_and_calculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ city: city, debug: false })
            });

            const result = await response.json();

            if (response.ok) {
                currentData = result;
                showSummaryStats(result);
                showRaceResults(result);
                resultsContainer.style.display = 'block';
                showStatus('‚úÖ Analiz tamamlandƒ±! Ko≈üulara tƒ±klayarak detaylarƒ± g√∂r√ºnt√ºleyebilirsiniz.', 'success');
            } else {
                showStatus('‚ùå Analiz hatasƒ±: ' + (result.error || 'Bilinmeyen hata'), 'danger');
            }
        } catch (error) {
            showStatus('‚ùå Analiz sƒ±rasƒ±nda hata olu≈ütu: ' + error.message, 'danger');
        }
    });

    // CSV indirme butonu
    downloadBtn.addEventListener('click', function() {
        const city = citySelect.value;
        if (!city || !currentData) {
            showStatus('‚ùå √ñnce bir analiz yapƒ±n!', 'warning');
            return;
        }

        const url = `/download_csv/${city}`;
        const a = document.createElement('a');
        a.href = url;
        a.download = `${city}_analiz_sonuclari.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        showStatus('üì• CSV dosyasƒ± indiriliyor...', 'info');
    });
});